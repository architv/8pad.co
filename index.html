<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>URL Shortener project</title>

<style type="text/css">
    textarea{
        width:300px;
        height:300px;
    }
    #article{
      width:300px;
      height:300px;
    }
</style>

<body>

<div class="container">
  <h3>Enter a text in the texbox below and click on the button below</h3>
  <textarea id="editor"></textarea>
  <br>
  <button id="submit">GO</button>
  <div id="article"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript" charset="utf-8"></script>


<script type="text/javascript" charset="utf-8">
    function get_short_url(long_url, login, api_key, func)
    {
    $.getJSON(
        "http://api.bitly.com/v3/shorten?callback=?", 
        { 
            "format": "json",
            "apiKey": api_key,
            "login": login,
            "longUrl": long_url
        },
        function(response)
        {
            func(response.data.hash);
        }
    );
    }

        function expand(url, callback) {
            $.ajax({
                dataType: 'jsonp',
                url: 'http://api.longurl.org/v2/expand',
                data: {
                    url: url,
                    format: 'json'
                },
                success: function(response) {
                    callback(response['long-url']);
                }
            });
        }

    
    function generateHash(s){
      return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);              
    }
    
    $('#submit').click(function(){
      var login = "stomatrix";
      var api_key = "R_c3691526084b291593c35ae2883e55cb";
      content = $('#editor').val();
      hash = generateHash(content);
      long_url = "http://"+hash+".com/"+content;
      get_short_url(long_url, login, api_key, function(short_url) {
        console.log(short_url);
        tag = "<br><a href='#{0}' target='_blank'>Your Article</a>".format(short_url);

        $( ".container" ).append(tag);
      });
      
    });

     $('document').ready(function() {
      if(window.location.hash) {
            var hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character
            console.log("hash found in url: "+hash);
            console.log(hash);
            $(".container").children().hide();
            $('#article').show();
            expand( encodeURIComponent('http://bit.ly/'+hash), function(response) {
                console.log(response);
                $('#article').text(response);
            });

        } else {
            $('#article').hide();
        }
     });

     function redirect(hash){
      window.location.href += "#"+hash;
      location.reload();
     }
      
      //via http://stackoverflow.com/a/4673436/1352702
      if (!String.prototype.format) {
        String.prototype.format = function() {
          var args = arguments;
          return this.replace(/{(\d+)}/g, function(match, number) { 
            return typeof args[number] != 'undefined'
              ? args[number]
              : match
            ;
          });
        };
      }     
    
</script>

</body>
</html>
