<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>URL Shortener project</title>

<style type="text/css">
    textarea{
        width:300px;
        height:300px;
    }
    #article{
      width:300px;
      height:300px;
      border: 1px dashed;
      background: ghostwhite;
    }
</style>

<body>

<div class="container">
  <h3>Enter a text in the texbox below and click on the button below</h3>
  <textarea id="editor"></textarea>
  <br>
  <button id="submit">GO</button>
  <div id="article"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript" charset="utf-8"></script>


<script type="text/javascript" charset="utf-8">
    function get_short_url(long_url, login, api_key, func){
        $.getJSON(
            "http://api.bitly.com/v3/shorten?callback=?", 
            { 
                "format": "json",
                "apiKey": api_key,
                "login": login,
                "longUrl": long_url
            },
            function(response)
            {
                func(response.data.hash);
            }
        );
    }
    
    function get_long_url(short_url, login, api_key, func){
        $.getJSON(
            "http://api.bitly.com/v3/expand?callback=?", 
            { 
                "format": "json",
                "apiKey": api_key,
                "login": login,
                "shortUrl": short_url
            },
            function(response)
            {
                func(response.data.expand[0].long_url);
            }
        );
    }
    
    
    var login = "stomatrix";
    var api_key = "R_c3691526084b291593c35ae2883e55cb";
    var long_url = "http://asdasdsad.com/#asdasd";

    
    function generateHash(s){
      return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);              
    }
    
    /*
    list=[];  //make global to allow in-place changes
    function cascade(content,list){
  
        var len=content.length
        splits=[];
        if (len>2000)
        {
            //var n=Math.ceil(len/2000);
            splits=content.match(/.{1,2000}/g);
            sl=splits.length;
            for (i = 0; i < sl; i++) { 
                list=cascade(splits[i],list);
            }
        } 
        else
        {
            list.push(content);
        }
        return list;
    }

    */
    
    $('#submit').click(function(){
      //var login = "stomatrix";
      //var api_key = "R_c3691526084b291593c35ae2883e55cb";
      content = $('#editor').val();
      content = encodeURIComponent(content);
      hash = generateHash(content);
      long_url = "http://"+hash+".com/"+content;
      get_short_url(long_url, login, api_key, function(short_url) {
        console.log(short_url);
        tag = "<br><a href='#{0}' target='_blank'>Your Article</a>".format(short_url);
        $( ".container" ).append(tag);

      });
      
    });

     $('document').ready(function() {
      if(window.location.hash) {
            var hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character
            console.log("hash found in url: "+hash);
            console.log(hash);
            $(".container").children().hide();
            $('#article').show();
            
            get_long_url('http://bit.ly/'+hash, login, api_key, function(long_url) {
              console.log(long_url);
              arr = long_url.split("/");
              content = arr[arr.length-1];
              content = decodeURIComponent(content);
              $('#article').text(content);
            });
            
            /*
            expand( encodeURIComponent('http://bit.ly/'+hash), function(response) {
                console.log(response);
                $('#article').text(response);
            });
            */

        } else {
            $('#article').hide();
        }
     });

      
      //via http://stackoverflow.com/a/4673436/1352702
      if (!String.prototype.format) {
        String.prototype.format = function() {
          var args = arguments;
          return this.replace(/{(\d+)}/g, function(match, number) { 
            return typeof args[number] != 'undefined'
              ? args[number]
              : match
            ;
          });
        };
      }     
   
</script>

</body>
</html>
